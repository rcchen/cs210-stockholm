function convertSymbolToText(e){return"<"==e?"less than (<)":"<="==e?"less than or equal (<=)":"="==e?"equals (=)":">="==e?"greater than or equal (>=)":">"==e?"greater than (>)":"!="==e?"not equal (!=)":"Contains"==e?"contains":void 0}var worksheetView,worksheet,worksheetToolbarView,footerView,Worksheet=Backbone.Model.extend({urlRoot:"/worksheets/",initialize:function(){this.on("change",this.updateOptions)},updateOptions:function(){}}),Visualization=Backbone.Model.extend({urlRoot:"/visualizations/"}),Dataset=Backbone.Model.extend({urlRoot:"/dataset/"}),VisualizationFilterView=Backbone.View.extend({el:"#storylytics-modals",events:{"click .filter-remove":"removeFilter"},initialize:function(e){this.options=e||{},console.log(this),this.render()},render:function(){var e=this,t=_.template(document.getElementById("visualization-filter-template").innerHTML,{attribute:e.options.attribute,condition:convertSymbolToText(e.options.condition),value:e.options.value,conditionValue:e.options.condition});return $("#filters").append(t),this},removeFilter:function(e){var t=$(e.target).closest(".filter");t.remove()}}),VisualizationSettingsView=Backbone.View.extend({el:"#storylytics-modals",events:{"change #visualization-dataset":"setDatasetAttributes","click #add-filter":"addFilter"},initialize:function(){this.bind("shown",this.setDatasetAttributes),this.bind("ok",this.saveAttributes),this.bind("hidden",this.teardown),_.bindAll(this,"beforeRender","render","afterRender");var e=this;this.render=_.wrap(this.render,function(t){return e.beforeRender(),t(),e.afterRender(),e})},beforeRender:function(){},render:function(){var e=this,t=_.template(document.getElementById("visualization-settings-template").innerHTML,{identifier:e.model.get("identifier")});return this.$el.html(t),this},afterRender:function(){$("#visualization-dataset").val(this.model.get("dataset")),$("#visualization-type").val(this.model.get("chart_type"));var e=this.model.get("filters");null!=e&&$.each(JSON.parse(e),function(e,t){new VisualizationFilterView({attribute:t.attribute,condition:t.conditional,value:t.value})})},setDatasetAttributes:function(){var e,t=this;e=null==t.model.get("dataset")?$("#visualization-dataset").val():t.model.get("dataset");var i=new Dataset({id:e});i.fetch({success:function(){var e=$("#filter-attribute");e.empty();var n=[];i.get("attrs").forEach(function(t){n.push(t.id),e.append($("<option></option>").attr("value",t.id).text(t.id))});var a=jQuery.parseJSON(t.model.get("chart_options"));null!=a&&(null!=a.key&&$("#visualization-keys").val(a.key),null!=a.value&&$("#visualization-values").val(a.value.join(","))),$("#visualization-keys").tagit({availableTags:n,showAutocompleteOnFocus:!0}),$("#visualization-values").tagit({availableTags:n,showAutocompleteOnFocus:!0})}})},saveAttributes:function(e){var t=$("#visualization-dataset").val(),i=$("#visualization-type").val(),n=$("#visualization-keys").tagit("assignedTags"),a=$("#visualization-values").tagit("assignedTags"),o={};("bar"==i||"line"==i||"pie"==i)&&(o={key:n[0],value:a});var s=[];$(".filter").each(function(){var e=$(this).find(".filter-attribute").text(),t=$(this).find(".filter-condition-value").text(),i=$(this).find(".filter-value").text(),n={attribute:e,conditional:t,value:i};s.push(n)}),console.log(s),this.model.set("dataset",t),this.model.set("chart_type",i),this.model.set("chart_options",o),this.model.set("filters",s),this.model.save(),e.close()},addFilter:function(){{var e=$("#filter-attribute").val(),t=$("#filter-condition").val(),i=$("#filter-value").val();new VisualizationFilterView({attribute:e,condition:t,value:i})}},teardown:function(){$("#storylytics-editor").after('<div id="storylytics-modals"></div>');var e=$("#"+this.model.id).find("iframe");e[0].src=e[0].src}}),VisualizationView=Backbone.View.extend({initialize:function(){var e=this;void 0==this.model.get("id")?this.model.save(null,{success:function(t,i,n){console.log("successbear"),console.log(t),console.log(i),console.log(n),e.model.id=t.get("identifier"),e.render()}}):this.model.fetch({success:function(){e.render()}})},render:function(){var e=this,t=_.template(document.getElementById("visualization-template").innerHTML,{identifier:e.model.get("identifier")});document.execCommand("insertHTML",null,t);var i=document.getElementById(this.model.get("identifier"));i.setAttribute("contenteditable","false"),this.setElement(i)},events:{"click #visualization-edit":"focusVisualization","click #visualization-destroy":"removeVisualization"},focusVisualization:function(){var e=this;console.log(e.model),e.model.fetch({success:function(){var t=new VisualizationSettingsView({model:e.model});console.log(t);{var i="Settings for "+t.model.get("identifier");new Backbone.BootstrapModal({animate:!0,escape:!1,title:i,content:t}).open()}}})},removeVisualization:function(){this.remove(),this.unbind()}}),WorksheetView=Backbone.View.extend({el:"#storylytics-editor",keyboardEvents:{"command+s":"save","ctrl+s":"save","command+e":"justifyCenter","ctrl+e":"justifyCenter","command+1":"insertVisualization","ctrl+1":"insertVisualization","command+2":"insertImage","ctrl+2":"insertImage"},initialize:function(){var e=this;this.listenTo(this.model,"change",this.render),this.model.fetch({success:function(){e.el.innerHTML=e.model.get("data"),e.activateVisualization()}})},render:function(){},save:function(e){e.preventDefault(),this.model.set({data:this.el.innerHTML}),this.model.save()},justifyCenter:function(e){e.preventDefault(),document.execCommand("justifyCenter",!1,null)},insertImage:function(e){var e=prompt("Image URL?");e&&document.execCommand("insertImage",!1,e)},insertVisualization:function(){{var e=new Visualization;new VisualizationView({model:e})}},activateVisualization:function(){$(".storylytics-visualization").each(function(){{var e=$(this).attr("id"),t=new Visualization({id:e});new VisualizationView({model:t})}})}}),WorksheetToolbarView=Backbone.View.extend({el:"#storylytics-menu",events:{"click #addImage":"addImage"},addImage:function(){worksheetView.insertImage()}});