!function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,i=function(t,i){function n(){this.constructor=t}for(var s in i)e.call(i,s)&&(t[s]=i[s]);return n.prototype=i.prototype,t.prototype=new n,t.__super__=i.prototype,t},n=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};if("undefined"==typeof Backbone||null===Backbone)throw new Error("Backbone is not defined. Please include the latest version from http://documentcloud.github.com/backbone/backbone.js");Backbone.Modal=function(e){function s(){this.triggerCancel=t(this.triggerCancel,this),this.triggerSubmit=t(this.triggerSubmit,this),this.triggerView=t(this.triggerView,this),this.clickOutside=t(this.clickOutside,this),this.checkKey=t(this.checkKey,this),this.args=Array.prototype.slice.apply(arguments),Backbone.View.prototype.constructor.apply(this,this.args),this.setUIElements(),this.delegateModalEvents()}return i(s,e),s.prototype.prefix="bbm",s.prototype.render=function(t){var e,i,n=this;return null==t&&(t={}),e=this.serializeData(),this.$el.addClass(""+this.prefix+"-wrapper"),this.modalEl=Backbone.$("<div />").addClass(""+this.prefix+"-modal"),this.template&&this.modalEl.html(this.template(e)),this.$el.html(this.modalEl),Backbone.$("body").on("keyup",this.checkKey),Backbone.$("body").on("click",this.clickOutside),this.viewContainer?(this.viewContainerEl=this.modalEl.find(this.viewContainer),this.viewContainerEl.addClass(""+this.prefix+"-modal__views")):this.viewContainerEl=this.modalEl,this.$el.show(),(null!=(i=this.views)?i.length:void 0)>0&&this.openAt(0),"function"==typeof this.onRender&&this.onRender(),this.modalEl.css({opacity:0}),this.$el.fadeIn({duration:100,complete:function(){return n.modalEl.css({opacity:1}).addClass(""+n.prefix+"-modal--open")}}),this},s.prototype.setUIElements=function(){var t;if(this.template=this.getOption("template"),this.views=this.getOption("views"),null!=(t=this.views)&&(t.length=_.size(this.views)),this.viewContainer=this.getOption("viewContainer"),this.$el.hide(),_.isUndefined(this.template)&&_.isUndefined(this.views))throw new Error("No template or views defined for Backbone.Modal");if(this.template&&this.views&&_.isUndefined(this.viewContainer))throw new Error("No viewContainer defined for Backbone.Modal")},s.prototype.getOption=function(t){return t?this.options&&n.call(this.options,t)>=0&&null!=this.options[t]?this.options[t]:this[t]:void 0},s.prototype.serializeData=function(){var t;return t={},this.model&&(t=_.extend(t,this.model.toJSON())),this.collection&&(t=_.extend(t,{items:this.collection.toJSON()})),t},s.prototype.delegateModalEvents=function(){var t,e,i,n,s,o,r;this.active=!0,t=this.getOption("cancelEl"),s=this.getOption("submitEl"),s&&this.$el.on("click",s,this.triggerSubmit),t&&this.$el.on("click",t,this.triggerCancel),r=[];for(e in this.views)"length"!==e?(i=e.match(/^(\S+)\s*(.*)$/),o=i[1],n=i[2],r.push(this.$el.on(o,n,this.views[e],this.triggerView))):r.push(void 0);return r},s.prototype.undelegateModalEvents=function(){var t,e,i,n,s,o,r;this.active=!1,t=this.getOption("cancelEl"),s=this.getOption("submitEl"),s&&this.$el.off("click",s,this.triggerSubmit),t&&this.$el.off("click",t,this.triggerCancel),r=[];for(e in this.views)"length"!==e?(i=e.match(/^(\S+)\s*(.*)$/),o=i[1],n=i[2],r.push(this.$el.off(o,n,this.views[e],this.triggerView))):r.push(void 0);return r},s.prototype.checkKey=function(t){if(this.active)switch(t.keyCode){case 27:return this.triggerCancel();case 13:return this.triggerSubmit()}},s.prototype.clickOutside=function(t){return Backbone.$(t.target).hasClass(""+this.prefix+"-wrapper")&&this.active?this.triggerCancel(null,!0):void 0},s.prototype.buildView=function(t){var e;return t?_.isFunction(t)?(e=new t(this.args[0]),e instanceof Backbone.View?{el:e.render().$el,view:e}:{el:t(this.args[0])}):{view:t,el:t.$el}:void 0},s.prototype.triggerView=function(t){var e,i,n,s;null!=t&&"function"==typeof t.preventDefault&&t.preventDefault(),s=t.data,i=this.buildView(s.view),this.currentView&&(this.previousView=this.currentView),this.currentView=i.view||i.el,e=0;for(n in this.views)s.view===this.views[n].view&&(this.currentIndex=e),e++;return s.onActive&&(_.isFunction(s.onActive)?s.onActive(this):_.isString(s.onActive)&&this[s.onActive].call(this,s)),this.shouldAnimate?this.animateToView(i.el):(this.shouldAnimate=!0,this.$(this.viewContainerEl).html(i.el))},s.prototype.animateToView=function(t){var e,i,n,s,o,r,h=this;return s={position:"relative",top:-9999,left:-9999},o=Backbone.$("<tester/>").css(s),o.html(this.$el.clone().css(s)),0!==Backbone.$("tester").length?Backbone.$("tester").replaceWith(o):Backbone.$("body").append(o),e=o.find(this.viewContainer?this.viewContainer:"."+this.prefix+"-modal"),e.removeAttr("style"),n=e.outerHeight(),e.html(t),i=e.outerHeight(),n===i?(this.$(this.viewContainerEl).html(t),null!=(r=this.previousView)&&"function"==typeof r.close?r.close():void 0):(this.$(this.viewContainerEl).css({opacity:0}),this.$(this.viewContainerEl).animate({height:i},100,function(){var e;return h.$(h.viewContainerEl).css({opacity:1}).removeAttr("style"),h.$(h.viewContainerEl).html(t),null!=(e=h.previousView)&&"function"==typeof e.close?e.close():void 0}))},s.prototype.triggerSubmit=function(t){return t&&(null!=t&&t.preventDefault(),!this.beforeSubmit||this.beforeSubmit()!==!1)?("function"==typeof this.submit&&this.submit(),this.regionEnabled?this.trigger("modal:close"):this.close()):void 0},s.prototype.triggerCancel=function(t){return null!=t&&t.preventDefault(),this.beforeCancel&&this.beforeCancel()===!1?void 0:("function"==typeof this.cancel&&this.cancel(),this.regionEnabled?this.trigger("modal:close"):this.close())},s.prototype.close=function(){var t=this;return Backbone.$("body").off("keyup",this.checkKey),Backbone.$("body").off("click",this.clickOutside),"function"==typeof this.onClose&&this.onClose(),this.shouldAnimate=!1,this.modalEl.addClass(""+this.prefix+"-modal--close"),this.$el.fadeOut({duration:200}),_.delay(function(){var e;return null!=(e=t.currentView)&&"function"==typeof e.remove&&e.remove(),t.remove()},200)},s.prototype.openAt=function(t){var e,i,n;e=0;for(i in this.views)"length"!==i&&(e===t&&(n=this.views[i]),e++);return n&&(this.currentIndex=t,this.triggerView({data:n})),this},s.prototype.next=function(){return this.currentIndex+1<this.views.length?this.openAt(this.currentIndex+1):void 0},s.prototype.previous=function(){return this.currentIndex-1<this.views.length-1?this.openAt(this.currentIndex-1):void 0},s}(Backbone.View)}.call(this);